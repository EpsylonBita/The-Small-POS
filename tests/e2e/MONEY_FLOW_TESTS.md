
# Money Flow End-to-End Tests

## Overview
This test suite covers the critical money flow scenarios in the POS system, ensuring financial data integrity from shift opening to Z-report submission. The validation includes interactions between the local POS (SQLite) and the Admin Dashboard (Supabase).

## Test Scenarios

### 1. Cashier Shift Lifecycle (`money-flow-cashier.spec.ts`)
Validates the complete lifecycle of a cashier shift:
- Shift opening with initial cash.
- Processing pickup orders (Cash & Card).
- Recording operational expenses.
- Processing staff payments (Wage).
- Shift closing with variance calculation and cash drawer reconciliation.

### 2. Driver Shift Lifecycle (`money-flow-driver.spec.ts`)
Validates driver specific workflows:
- Opening shift with starting amount (borrowed from cashier).
- Delivery order processing and completion.
- Expense tracking (Fuel).
- End of shift reconciliation and earnings calculation.

### 3. Waiter Shift Lifecycle (`money-flow-waiter.spec.ts`)
Validates waiter workflows:
- Table service and dine-in order processing.
- Expense tracking (Breakage).
- Shift closing and payment.

### 4. Cashier Handover (`money-flow-cashier-handover.spec.ts`)
Validates the complex logic of transferring active drivers between cashier shifts:
- Ensuring drivers are not forced closed when their cashier closes.
- Transferring liability and open orders to the next cashier.
- Accurate cash expectation calculations across the handover.

### 5. Z-Report Generation (`money-flow-z-report.spec.ts`)
Validates the end-of-day aggregation:
- Aggregating sales, expenses, and payments from all roles (Cashier, Driver, Waiter).
- Verifying totals match the sum of individual shifts.
- Validating per-staff analytics breakdown.
- Submission of the Z-report to the Admin Dashboard.

## Running Tests

### POS System Tests
Run from `pos-system/` directory:

```bash
# Run all money flow tests
npm run test:money-flow:all

# Run specific scenarios
npm run test:money-flow:cashier
npm run test:money-flow:driver
npm run test:money-flow:waiter
npm run test:money-flow:handover
npm run test:money-flow:z-report
```

### Admin Dashboard Integration Tests
Run from `admin-dashboard/` directory:

```bash
# Run all integration tests
npm run test:money-flow:all

# Run specific tests
npm run test:money-flow:z-report
npm run test:money-flow:display
```

## Debugging
- Use `npx playwright test --debug` to step through POS tests.
- Check `console.log` output in terminal for test steps.
- Ensure Supabase mock env vars are set correctly for integration tests.

## CI/CD Integration
These tests are designed to run in CI environment. Ensure the Electron app is built or available for the E2E tests, and that the Admin Dashboard tests have access to the mock environment.

## Expected Results
- All variances should be 0 unless specific variance scenarios are tested.
- Z-Report totals must exactly match the sum of individual shift transactions.
- Admin Dashboard should receive and display the identical data structure generated by the POS.
