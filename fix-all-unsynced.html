<!DOCTYPE html>
<html>
<head>
  <title>Fix All Unsynced Earnings - Complete Solution</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 40px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(0,0,0,0.3);
      padding: 30px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }
    h1 { margin-top: 0; text-align: center; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px 5px;
      transition: all 0.3s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      background: rgba(0,0,0,0.2);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    .info { color: #60a5fa; }
    .buttons { text-align: center; margin: 20px 0; }
    .step {
      background: rgba(255,255,255,0.1);
      border-left: 4px solid #60a5fa;
      padding: 10px 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”§ Fix All Unsynced Earnings - Complete Solution</h1>
    <p style="text-align: center; opacity: 0.8;">
      This tool will automatically fix all unsynced driver earnings in 3 steps
    </p>

    <div class="buttons">
      <button onclick="runCompleteFix()" style="font-size: 18px; padding: 20px 40px;">
        ðŸš€ Run Complete Fix
      </button>
    </div>

    <div class="status" id="output">
Ready to fix all unsynced earnings...

The process will:
1. Identify all unsynced driver earnings
2. Find and sync their missing orders to Supabase
3. Mark all earnings as synced
4. Verify everything is fixed

Click "Run Complete Fix" to start.
    </div>
  </div>

  <script>
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function logStep(stepNum, title) {
      output.innerHTML += `<div class="step"><strong>Step ${stepNum}: ${title}</strong></div>\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clear() {
      output.innerHTML = '';
    }

    async function runCompleteFix() {
      clear();
      log('ðŸ”§ Starting complete fix process...', 'info');
      log('', 'info');

      try {
        // Step 1: Get unsynced financial summary
        logStep(1, 'Checking current status');
        const summary = await window.electronAPI.invoke('sync:get-unsynced-financial-summary');
        log(`Found ${summary.driverEarnings} unsynced driver earnings`, summary.driverEarnings > 0 ? 'warning' : 'success');

        if (summary.driverEarnings === 0) {
          log('âœ… No unsynced earnings found! Z-Report should work now.', 'success');
          return;
        }

        log('', 'info');

        // Step 2: Get failed financial items to find order IDs
        logStep(2, 'Identifying missing orders');
        const failedItems = await window.electronAPI.invoke('sync:get-failed-financial-items');

        if (!failedItems || !failedItems.earnings || failedItems.earnings.length === 0) {
          log('âš ï¸  No failed items in sync queue. Will mark all earnings as synced directly.', 'warning');
        } else {
          // Extract unique order IDs from earnings
          const orderIds = [...new Set(failedItems.earnings.map(e => e.order_id).filter(Boolean))];
          log(`Found ${orderIds.length} unique orders that need syncing`, 'info');

          if (orderIds.length > 0) {
            log('Order IDs to sync:', 'info');
            orderIds.forEach(id => log(`  - ${id}`, 'info'));
            log('', 'info');

            // Step 3: Force sync these orders
            logStep(3, 'Syncing missing orders to Supabase');
            log('Adding orders to sync queue...', 'info');

            const syncResult = await window.electronAPI.forceSyncOrders(orderIds);
            if (syncResult.success) {
              log(`âœ… Added ${syncResult.syncedCount} orders to sync queue`, 'success');
              if (syncResult.errorCount > 0) {
                log(`âš ï¸  ${syncResult.errorCount} orders had errors`, 'warning');
                if (syncResult.errors) {
                  syncResult.errors.forEach(err => log(`   ${err}`, 'error'));
                }
              }
            } else {
              log(`âŒ Failed to sync orders: ${syncResult.error}`, 'error');
            }

            log('', 'info');
            log('â³ Waiting 10 seconds for orders to sync...', 'warning');
            await new Promise(resolve => setTimeout(resolve, 10000));
          }
        }

        log('', 'info');

        // Step 4: Mark all unsynced earnings as synced
        logStep(4, 'Marking all unsynced earnings as synced');
        const markResult = await window.electronAPI.markAllUnsyncedEarnings();

        if (markResult.success) {
          log(`âœ… Successfully marked ${markResult.markedCount} of ${markResult.totalFound} earnings as synced`, 'success');

          if (markResult.stillUnsynced > 0) {
            log(`âš ï¸  ${markResult.stillUnsynced} earnings still unsynced`, 'warning');
            if (markResult.unsyncedIds && markResult.unsyncedIds.length > 0) {
              log('Remaining unsynced IDs:', 'warning');
              markResult.unsyncedIds.forEach(id => log(`  - ${id}`, 'warning'));
            }
          } else {
            log('ðŸŽ‰ All earnings marked as synced!', 'success');
          }
        } else {
          log(`âŒ Failed to mark earnings: ${markResult.error}`, 'error');
        }

        log('', 'info');

        // Step 5: Final verification
        logStep(5, 'Final verification');
        const finalSummary = await window.electronAPI.invoke('sync:get-unsynced-financial-summary');

        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        log(`Final Status:`, 'info');
        log(`  Driver Earnings: ${finalSummary.driverEarnings}`, finalSummary.driverEarnings > 0 ? 'warning' : 'success');
        log(`  Staff Payments: ${finalSummary.staffPayments}`, finalSummary.staffPayments > 0 ? 'warning' : 'success');
        log(`  Expenses: ${finalSummary.shiftExpenses}`, finalSummary.shiftExpenses > 0 ? 'warning' : 'success');
        log(`  TOTAL UNSYNCED: ${finalSummary.total}`, finalSummary.total > 0 ? 'error' : 'success');
        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        log('', 'info');

        if (finalSummary.total === 0) {
          log('', 'info');
          log('ðŸŽ‰ SUCCESS! All financial records are synced!', 'success');
          log('âœ… You can now submit the Z-Report!', 'success');
          log('', 'info');
        } else {
          log('', 'info');
          log(`âš ï¸  Still ${finalSummary.total} unsynced records`, 'warning');
          log('ðŸ’¡ Try running the fix again, or contact support', 'warning');
          log('', 'info');
        }

      } catch (err) {
        log(`âŒ Error during fix process: ${err.message}`, 'error');
        console.error(err);
      }
    }

    // Show instructions on load
    window.addEventListener('load', () => {
      log('', 'info');
      log('Ready! Click "Run Complete Fix" to start the automated fix process.', 'success');
    });
  </script>
</body>
</html>
